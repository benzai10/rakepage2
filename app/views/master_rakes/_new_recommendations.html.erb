<ul id="feed-list" class="leaflet-list">
  <% leaflet_duplication_array = [] %>
  <% @new_recommendations.each do |lm| %>
    <% l = Leaflet.find(lm.leaflet_id) %>
    <% if !leaflet_duplication_array.include? l.id %>
      <% leaflet_duplication_array << l.id %>

      <li class="rake-show-list">
        <a class="pull-left" href="#">
          <% channel = Channel.find(l.channel_id) %>
          <% if channel.channel_type == 4 %>
            <%= image_tag "reddit-32.png", size: "16x16", class: "media-object img-feed-show" %>
          <% elsif channel.channel_type == 3 %>
            <%= image_tag "rakepage_logo_transparent_32x32.png", size: "16x16", class: "media-object img-feed-show" %>
          <% else %>
            <% favicon_path = "http://www.google.com/s2/favicons?domain=" + channel.source %>
            <img class="media-object img-feed-show" src=<%= "#{favicon_path}" %> alt="media image">
          <% end %>
        </a>
        <div class="media-body">
          <span class="feed-timestamp">
            <%#= Channel.find(l.channel_id).name %>
            <%= link_to lm.master_heap.master_rake.name, master_rake_path(lm.master_heap.master_rake) %>
              &nbsp;|&nbsp;
            <%= link_to LeafletType.find_by_leaflet_type(lm.master_heap.leaflet_type_id).leaflet_type_desc, master_rake_path(lm.master_heap.master_rake, collapse: "heap_" + lm.master_heap.leaflet_type_id.to_s) %>
            <% if !l.created_by.nil? %>
              &nbsp;|&nbsp;
              added by <%= User.find(l.created_by).username %>
            <% end %>
            <span class="pull-right-menu">
              <% if !l.published_at.nil? %>
                <%= time_ago_in_words(l.published_at) %> ago 
              <% else %>
                <%= time_ago_in_words(l.created_at) %> ago 
              <% end %>
            </span>
          </span>
          <br>
          <span class="leaflet-title">
            <%= link_to l.title.html_safe, l.url, class: "external", value: l.id, target: "_blank" %>
          </span>
            <% content = l.content.gsub(/\<a href=["'](.*?)["']\>(.*?)\<\/a\>/mi, '<a href="\1" target="_blank" >\2</a>') %>
            <% content = content.gsub(/<a href=\"\/r\//, '<a href="http://reddit.com/r/') %>
            <% content = content.gsub(/<a href=\"\/u\//, '<a href="http://reddit.com/u/') %>
          <p class="feed-body"><%= raw content unless l.content == "No content details to display." %></p>
          <br>
          <span class="leaflet-metrics">
            Viewed <span class="v_count_<%= l.id %>"><%= l.view_count %></span>
            &nbsp;|&nbsp;
            Saved <span class="s_count_<%= l.id %>"><%= l.save_count %></span>
            &nbsp;|&nbsp;
            Deleted <span class="d_count_<%= l.id %>"><%= l.delete_count %></span>
          </span>
          <span class="pull-right">
            <span class="feed-button">
              <span id="<%= 'feed-heart-icon-' + l.id.to_s %>">
                <% if Feed.where("leaflet_id = ? AND status = 1", l.id).count > 0 %>
                  &nbsp;<i class="fa fa-heart" data-toggle="tooltip" data-placement="top" title="Liked count"></i>
                <% else %>
                  &nbsp;<i class="fa fa-heart-o like" data-toggle="tooltip" data-placement="top" title="Like" value=<%= l.id %>></i>
                <% end %>
              </span>
              <span class="l_count_<%= l.id %>"><%= l.like_count %></span>
            </span>
            &nbsp;
            <span id="<%= 'feed_star_icon_' + l.id.to_s %>">
              <% if user_signed_in? %>
                <% heap_ids = Heap.where("myrake_id IN (?)", Myrake.where(user_id: current_user.id).pluck(:id)).pluck(:id) %>
                <% user_leaflet_ids = HeapLeafletMap.where("heap_id IN (?)", heap_ids).pluck(:leaflet_id) %>
                <% if user_leaflet_ids.include? l.id %>
                  &nbsp;<i class="fa fa-star"></i>
                <% else %>
                  <%# user_rake = lm.master_heap.master_rake.myrakes.where(user_id: current_user.id).first %>
                  <%# if !user_rake.nil? %>
                    <span class="feed-button">
                      <%= link_to '&nbsp;'.html_safe + '<i class="fa fa-save" data-toggle="tooltip" data-placement="top" title="Save to Heap"></i>'.html_safe, 
                            "#", 
                            data: { toggle: "modal",
                                    target: "#saveLeafletModal2",
                                    id: l.id },
                            class: "leaflet-master-save" %>
                    </span>
                  <%# else %>
                    <!-- <span class="feed-button"> -->
                      <%#= link_to '&nbsp;'.html_safe + '<i class="fa fa-save" data-toggle="tooltip" data-placement="top" title="Save to Heap"></i>'.html_safe, "#",
                                  data: { toggle: "modal",
                                          target: "#infoCreateRakeModal" } %>
                    <!-- </span> -->
                  <%# end %>
                <% end %>
              <% else %>
                <span class="feed-button">
                  <%= link_to '&nbsp;'.html_safe + '<i class="fa fa-save"
                              data-toggle="tooltip" 
                              data-placement="top" 
                              title="Save to Heap"></i>'.html_safe,
                              new_user_session_path %>
                </span>
              <% end %>
            </span>
            &nbsp;
          </span>
        </div>
        <hr>
      </li>
    <% end %>
  <% end %>
</ul>