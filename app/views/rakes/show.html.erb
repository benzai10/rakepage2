<div class="container-fluid">
<%= render 'rakes/rakes_menu' %>
<div class="row">
  <div class="col-md-3">
    <h5>
      <small>
        <% category_id = @rake.master_rake.category_id %>
        <% if user_signed_in? && @rake.user_id == current_user.id %>
          <%= link_to "MY RAKES", rakes_path %>
          &nbsp;|&nbsp;<%= link_to Category.find(category_id).desc.upcase, rakes_path(category_id: category_id) %>
        <% else %>
          <%= User.find(@rake.user_id).username.upcase %>'S RAKES
          &nbsp;|&nbsp;<%= Category.find(category_id).desc.upcase %>
        <% end %>
      </small>
    </h5>
    <p>
      <% if !current_user.nil? %>
        <%= link_to "<i class='fa fa-sitemap white'></i>".html_safe + " Show Master Rake",
                      master_rake_path(@rake.master_rake_id),
                      class: "btn btn-primary btn-block" %>
      <% end %>
    </p>
    <div class="panel-group" id="accordion">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h5 class="panel-title">
            <% href_id = "#feed" %>
            <%= link_to "News", rake_path(heap_type: "News") %>
            <% if params[:heap_type] == "News" %>
              <span class="pull-right" id="refresh-icon">
                <%#= link_to '<i class="fa fa-info"></i>'.html_safe, href_id, 
                            :data => { :toggle => "collapse" },
                            id: "feed-chevron" %>
                <%= link_to '<i class="fa fa-refresh"></i>'.html_safe, rake_path(@rake, refresh: "yes") %>
              </span>
            <% end %>
          </h5>
        </div>
        <% if params[:heap_type] == "News" %>
          <div id="feed" class="panel-collapse collapse in">
        <% else %>
          <div id="feed" class="panel-collapse collapse">
        <% end %>
            <div class="panel-body">
              <span class="channel-title">Recently added Channels:</span>
              <br>
              <ul class="leaflet-list">
                <% MasterRake.find(@rake.master_rake_id).channels.where("channel_type <> 3 AND channel_type <> 5").order("created_at DESC").limit(5).each do |c| %>
                  <% if !@rake.channels.include? c %>
                    <li class="channel-list" id="<%= 'channel_' + c.id.to_s %>">
                      <span class="pull-left">
                        <% favicon_path = "http://www.google.com/s2/favicons?domain=" + c.source %>
                        <img class="media-object img-rake-show" src=<%= "#{favicon_path}" %> alt="media image">
                      </span>
                      <div class="media-body">
                        <h5 class="media-heading channel-heading">
                          <%= c.name %>
                          <span class="pull-right">
                          <%= link_to '<i class="fa fa-plus"></i>'.html_safe,
                                add_channel_rake_path(@rake, channel: c.id),
                                title: "Add Channel to own Rake" %>
                          </span>
                        </h5>
                        <p>
                          <i class="fa fa-star"></i> <%= Leaflet.where("channel_id = '#{c.id}'").sum(:save_count) %>
                          <i class="fa fa-user"></i> <%= c.count_subscribers %>
                          <i class="fa fa-tasks"></i> <%= Leaflet.where("channel_id = '#{c.id}'").count %>
                        </p>
                      </div>
                    </li>
                  <% end %>
                <% end %>
              </ul>
            </div>
          </div>
      </div>
      <p>
        <h5>
          <small>
            HEAPS
            <span class="pull-right-menu">
              <%= link_to "ADD HEAP", "#",
                            data: {
                              toggle: "modal",
                              target: "#addHeapModal"
                              } %>
            </span>
          </small>
        </h5>
      </p>
      <% @heaps.each do |h| %>
        <div class="panel panel-default">
          <div class="panel-heading">
            <h5 class="panel-title">
              <% leaflet_type_desc = LeafletType.find(h.leaflet_type_id).leaflet_type_desc %>
              <% href_id = "#heap_" + h.leaflet_type_id.to_s %>
              <%= link_to leaflet_type_desc, rake_path(heap_type: h.leaflet_type_id) %>
              <% if params[:heap_type].to_i == h.leaflet_type_id && !params[:heap_type] == "News" %>
                <span class="pull-right">
                  <%= link_to '<i class="fa fa-info purple"></i>'.html_safe, href_id, 
                              :data => { :toggle => "collapse" },
                              id: "feed-chevron" %>
                </span>
              <% end %>
            </h5>
          </div>
          <% if params[:heap_type].to_i == h.leaflet_type_id && params[:heap_type] != "News" %>
            <div id="heap_<%= "#{h.leaflet_type_id}" %>" class="panel-collapse collapse in">
              <div class="panel-body">
                <h5>
                  <span>
                    <i class="fa fa-leaf"></i> <%= " " + h.leaflets.count.to_s %>
                  </span>
                  <small><span class="pull-right-menu">
                  <%= link_to '<i class="fa fa-plus"></i>'.html_safe + " ADD LEAFLET", new_leaflet_path, 
                              data: {
                                toggle: "modal",
                                target: "#newLeafletModal",
                                heapid: h.id,
                                typeid: h.leaflet_type_id
                              },
                              class: "leaflet-create" %>
                  </span></small>
                </h5>
              </div>
            </div>
          <% else %>
            <div id="heap_<%= "#{h.leaflet_type_id}" %>" class="panel-collapse collapse">
              <div class="panel-body">
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
  <div class="col-md-6">
    <% if params[:heap_type] == "News" %>
      <h5><small><%= @rake.name.upcase %> | NEWS</small></h5>
      <%= render 'feed' %>
    <% else %>
      <h5><small><%= @rake.name.upcase %> | <%= LeafletType.find(params[:heap_type].to_i).leaflet_type_desc.upcase %></small></h5>
      <%= render 'heap', locals: { leaflet_type_id: params[:heap_type] } %>
    <% end %>
  </div>
</div>

<%= render 'rakes/leaflet_save_modal' %>
<%= render 'rakes/leaflet_create_modal' %>
<%= render 'rakes/heap_add_modal' %>
<%#= render 'rakes/social_modal' %>
</div>
